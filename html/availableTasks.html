<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Available Volunteer Tasks</title>
  <style>
    /* Basic table styles */
    #tasks-table {
      width: 100%;
      border-collapse: collapse;
      font-family: Arial, sans-serif;
    }
    #tasks-table th, #tasks-table td {
      border: 1px solid #36454F; /* Charcoal */
      padding: 8px;
      text-align: left;
    }
    #tasks-table th {
      background-color: #008000; /* Green */
      color: white;
    }
    /* Alternate row background for clarity */
    #tasks-table tr:nth-child(even) {
      background-color: #FFD700; /* Yellow */
    }
    /* Group header row */
    #tasks-table tr.group-header td {
      background-color: #36454F; /* Charcoal */
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="clickup-widget">
    <h2>Available Volunteer Tasks <br />(last updated: <span id="last-updated"></span>)</h2>
    <div id="table-container"></div>
  </div>

  <script>
  // Helper function to extract a custom field value (for drop_down fields)
  function getCustomFieldValue(task, fieldName) {
    if (!task.custom_fields) return null;
    
    // Look for exact match first
    const exactField = task.custom_fields.find(f => f.name && f.name.trim() === fieldName);
    if (exactField) {
      // If a human-readable value is provided (value_text), use it.
      if (exactField.value_text) {
        return exactField.value_text.trim();
      }
      // Otherwise, if "value" is a number, treat it as an index into the options array.
      if (typeof exactField.value === "number" && exactField.type_config && Array.isArray(exactField.type_config.options)) {
        const idx = exactField.value;
        if (idx >= 0 && idx < exactField.type_config.options.length) {
          return exactField.type_config.options[idx].name.trim();
        }
      }
    }
    
    // If no exact match, check for field that contains the fieldName (case insensitive)
    const containsField = task.custom_fields.find(f => 
      f.name && f.name.trim().toLowerCase().includes(fieldName.toLowerCase())
    );
    
    if (containsField) {
      // If a human-readable value is provided (value_text), use it.
      if (containsField.value_text) {
        return containsField.value_text.trim();
      }
      // Otherwise, if "value" is a number, treat it as an index into the options array.
      if (typeof containsField.value === "number" && containsField.type_config && Array.isArray(containsField.type_config.options)) {
        const idx = containsField.value;
        if (idx >= 0 && idx < containsField.type_config.options.length) {
          return containsField.type_config.options[idx].name.trim();
        }
      }
    }
    
    return null;
  }

  // Helper to get the numeric sort value from the "Order!" field.
  // If the extracted value is numeric, return that number; otherwise, return a very high number.
  function getOrderValue(task) {
    const orderVal = getCustomFieldValue(task, "Order!");
    if (orderVal === null) return Infinity;
    const num = parseInt(orderVal, 10);
    return isNaN(num) ? Infinity : num;
  }

  // Main function to render the table.
  document.addEventListener("DOMContentLoaded", function() {
    // Fetch tasks from your Vercel endpoint.
    fetch('https://api.voluntaria.community/api/availableTasks?ts=' + new Date().getTime(), { cache: "no-store" })
      .then(response => response.json())
      .then(data => {
        const tasks = data.tasks || [];
        
        // Calculate the most recent date_updated.
        // Ensure we convert date_updated from string to number.
        const mostRecentTimestamp = Math.max(...tasks.map(task => Number(task.date_updated) || 0));
        const mostRecentDate = new Date(mostRecentTimestamp).toLocaleString();
        document.getElementById("last-updated").innerText = mostRecentDate;

        // First check if there are any tasks
        if (tasks.length === 0) {
          document.getElementById("table-container").innerHTML = "<p>No volunteer tasks available at this time.</p>";
          return;
        }

        // Group tasks by the Area custom field
        const groups = {};
        tasks.forEach(task => {
          const area = getCustomFieldValue(task, "Area") || getCustomFieldValue(task, "area") || "Uncategorized";
          if (!groups[area]) {
            groups[area] = [];
          }
          groups[area].push(task);
        });
        
        // Sort the group keys alphabetically.
        const groupKeys = Object.keys(groups).sort();
        
        // For each group, sort tasks by the Order! field.
        groupKeys.forEach(key => {
          groups[key].sort((a, b) => getOrderValue(a) - getOrderValue(b));
        });
        
        // Build the HTML table.
        let html = '<table id="tasks-table">';
        html += '<thead><tr><th>Priority</th><th>Task</th></tr></thead>';
        html += '<tbody>';
        
        // For each group, output a header row and then each task row.
        groupKeys.forEach(area => {
          // Group header row spanning all columns.
          html += `<tr class="group-header"><td colspan="2">${area}</td></tr>`;
          groups[area].forEach(task => {
            // Get the Order! value for display.
            let orderValue = getCustomFieldValue(task, "Order!");
            if (orderValue === null) orderValue = "";
            
            // Create a link to the task if available
            let taskName = task.name;
            if (task.url) {
              taskName = `<a href="${task.url}" target="_blank">${task.name}</a>`;
            }
            
            html += `<tr>`;
            html += `<td>${orderValue}</td>`;
            html += `<td>${taskName}</td>`;
            html += `</tr>`;
          });
        });
        
        html += '</tbody></table>';
        
        // Insert the table into the container.
        document.getElementById("table-container").innerHTML = html;
      })
      .catch(error => {
        console.error("Error fetching tasks:", error);
        document.getElementById("table-container").innerHTML = "<p>Error loading tasks.</p>";
      });
  });
  </script>
</body>
</html>
