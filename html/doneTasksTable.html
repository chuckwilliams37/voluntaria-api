<style>
    /* Collapsible container styling */
    .collapsible {
      background-color: #36454F; /* Charcoal */
      color: white;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      margin-bottom: 5px;
    }
    .collapsible.active, .collapsible:hover {
      background-color: #008000; /* Green */
    }
    .content {
      padding: 0 10px;
      display: none;
      overflow: hidden;
    }
    
    /* Table styling */
    #done-tasks-table {
      width: 100%;
      border-collapse: collapse;
      font-family: Arial, sans-serif;
      margin-top: 10px;
    }
    #done-tasks-table th, #done-tasks-table td {
      border: 1px solid #36454F; /* Charcoal */
      padding: 8px;
      text-align: left;
    }
    #done-tasks-table th {
      background-color: #008000; /* Green */
      color: white;
    }
    #done-tasks-table tr:nth-child(even) {
      background-color: #FFD700; /* Yellow */
    }
  </style>
  
  <div id="done-tasks-widget">
    <button class="collapsible">Completed Tasks (Most Recent on Top)</button>
    <div class="content">
      <div id="done-tasks-table-container">Loading completed tasksâ€¦</div>
    </div>
  </div>
  
  <script>
    // Toggle the collapsible content on click.
    document.addEventListener("DOMContentLoaded", function() {
      var coll = document.getElementsByClassName("collapsible");
      for (var i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          content.style.display = (content.style.display === "block") ? "none" : "block";
        });
      }
    });
  
    // Helper: Format a timestamp (assumed in milliseconds) as a locale string.
    function formatTimestamp(ts) {
      if (!ts) return "";
      return new Date(Number(ts)).toLocaleString();
    }
  
    // Helper: Convert time_estimate (milliseconds) to hours.
    function formatTimeEstimate(ms) {
      if (!ms || isNaN(ms)) return "";
      const hours = Number(ms) / 3600000; // 3,600,000 ms per hour
      return hours.toFixed(2) + " hrs";
    }
  
    // Helper: Get the first name from a full name.
    function getFirstName(fullName) {
      if (!fullName) return "";
      return fullName.trim().split(" ")[0];
    }
  
    // Helper: Render the array of assignees as a comma-separated list of first names.
    function renderAssignees(assignees) {
      if (!assignees || assignees.length === 0) return "";
      return assignees.map(a => getFirstName(a.username)).join(", ");
    }
  
    // Fetch completed tasks from the live API.
    document.addEventListener("DOMContentLoaded", function() {
      // Use your live API URL with flags to include completed tasks.
      // (Adjust the URL if needed.)
      const endpoint = "https://api.clickup.com/api/v2/team/9017099981/task?include_closed=true&statuses[]=complete&ts=" + new Date().getTime();
      fetch(endpoint, { cache: "no-store" })
        .then(response => response.json())
        .then(data => {
          const tasks = data.tasks || [];
          // Sort tasks so the most recent completed tasks (based on date_done) appear on top.
          tasks.sort((a, b) => Number(b.date_done || 0) - Number(a.date_done || 0));
  
          let html = '<table id="done-tasks-table">';
          html += '<thead><tr>';
          html += '<th>Completed On</th>';
          html += '<th>Task Name</th>';
          html += '<th>Time Logged</th>';
          html += '<th>Assignees</th>';
          html += '<th>Creator</th>';
          html += '</tr></thead><tbody>';
  
          if (tasks.length === 0) {
            html += '<tr><td colspan="5">No completed tasks found.</td></tr>';
          } else {
            tasks.forEach(task => {
              const completedOn = formatTimestamp(task.date_done);
              const taskName = task.name || "";
              const timeLogged = formatTimeEstimate(task.time_estimate);
              const assignees = renderAssignees(task.assignees);
              const creator = task.creator ? getFirstName(task.creator.username) : "";
  
              html += '<tr>';
              html += `<td>${completedOn}</td>`;
              html += `<td>${taskName}</td>`;
              html += `<td>${timeLogged}</td>`;
              html += `<td>${assignees}</td>`;
              html += `<td>${creator}</td>`;
              html += '</tr>';
            });
          }
  
          html += '</tbody></table>';
          document.getElementById("done-tasks-table-container").innerHTML = html;
        })
        .catch(error => {
          console.error("Error fetching completed tasks:", error);
          document.getElementById("done-tasks-table-container").innerHTML = "<p>Error loading completed tasks.</p>";
        });
    });
  </script>
  